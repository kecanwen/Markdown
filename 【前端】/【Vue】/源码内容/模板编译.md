> 模版编译过程主要如下：**template -> ast -> render函数**

![image-20220216135800068](C:\Users\10072598\AppData\Roaming\Typora\typora-user-images\image-20220216135800068.png)

vue中的模板template**无法被浏览器解析**并渲染，因为这**不属于浏览器的标准**，不是正确的HTML语法，所有需要将template转化成一个JavaScript函数，这样浏览器就可以执行这一个函数并渲染出对应的HTML元素，就可以让视图跑起来了，这一个转化的过程，就成为模板编译。

> `<template></template>`标签中写的模板对`Vue`来说就是一堆字符串

**模板编译又分三个阶段**，**解析**parse，**优化**optimize，**生成**generate，最终生成可执行函数render

- **解析阶段**：使用大量的正则表达式对template字符串进行解析，将标签、指令、属性等转化为抽象语法树AST。
- **优化阶段**：遍历AST，找到其中的一些静态节点并进行标记，方便在页面重渲染的时候进行diff比较时，直接跳过这一些静态节点，优化runtime的性能。
- **生成阶段**：将最终的AST转化为render函数。

### 主要详细过程如下∶

**1、调用parse方法将template转化为ast（抽象语法树）**

- **parse的目标**：把template转换为AST树，它是一种用 JavaScript对象的形式来描述整个模板。

​		[AST在线转换网站](https://astexplorer.net/)

- **解析过程**：利用正则表达式顺序解析模板，当解析到开始标签、闭合标签、文本的时候都会分别执行对应的 回调函数，来达到构造AST树的目的。

> AST元素节点总共三种类型：type为1表示普通元素、2为表达式、3为纯文本

**2、对静态节点做优化**

​		这个过程主要分析出哪些是静态节点，给其打一个标记，为后续更新渲染可以直接跳过静				态节点做优化

> `DOM-Diff` 算法会直接跳过静态节点，减少了比较的过程，优化了 `patch` 的性能

​		深度遍历AST，查看每个子树的节点元素是否为静态节点或者静态节点根。如果为静态节	   		点，他们生成的DOM永远不会改变，这对运行时模板更新起到了极大的优化作用。

**3、生成代码**

​		 generate将ast抽象语法树编译成 renderStr字符串并将静态部分放到单独容器中，最后通			过`new Function(renderStr)`生成render函数。

> 总结：
>
> 1. 模板解析阶段：将一堆模板字符串用正则等方式解析成抽象语法树`AST`；
> 2. 优化阶段：遍历`AST`，找出其中的静态节点，并打上标记；
> 3. 代码生成阶段：将`AST`转换成渲染函数；

![image-20220216142446738](C:\Users\10072598\AppData\Roaming\Typora\typora-user-images\image-20220216142446738.png)

